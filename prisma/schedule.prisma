// CoachAvailability: Weekly recurring availability pattern for coach (e.g., Mon-Fri 10AM-4PM)
model CoachAvailability {
    id        String    @id @default(auto()) @map("_id") @db.ObjectId
    coachId   String    @db.ObjectId
    dayOfWeek DayOfWeek // Specific day of week
    startTime DateTime // Start time (time only, e.g., 10:00:00)
    endTime   DateTime // End time (e.g., 16:00:00)
    isActive  Boolean   @default(true) // Day active or not (e.g., Sunday false)

    coach     Coach      @relation(fields: [coachId], references: [id])
    timeSlots TimeSlot[] // Slots generated from this availability

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([coachId, dayOfWeek]) // One pattern per day per coach
    @@map("coach_availabilities")
}

// TimeSlot: Hourly slots within availability (recurring template, e.g., 10-11 AM)
model TimeSlot {
    id             String   @id @default(auto()) @map("_id") @db.ObjectId
    availabilityId String   @db.ObjectId
    startTime      DateTime // Slot start time (relative, e.g., 10:00:00)
    endTime        DateTime // Slot end time (e.g., 11:00:00)
    isBooked       Boolean  @default(false) // Globally booked flag (for template; actual per date in Booking)

    availability CoachAvailability @relation(fields: [availabilityId], references: [id])
    bookings     Booking[] // Actual bookings using this slot type

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("time_slots")
}

// Booking: Specific instance of a booking (date + slot, with status for workflow)
model Booking {
    id               String        @id @default(auto()) @map("_id") @db.ObjectId
    athleteId        String        @db.ObjectId // Athlete booking
    coachId          String        @db.ObjectId // Coach involved
    timeSlotId       String        @db.ObjectId // References slot template
    bookingDate      DateTime // Full datetime (specific date + slot time)
    status           BookingStatus @default(PENDING) // Workflow status
    rescheduleFromId String?       @db.ObjectId // Link to old booking for reschedule
    notes            String? // Optional notes (e.g., session type)

    athlete         Athlete   @relation(fields: [athleteId], references: [id])
    coach           Coach     @relation(fields: [coachId], references: [id])
    timeSlot        TimeSlot  @relation(fields: [timeSlotId], references: [id])
    // Self-relation for chain
    rescheduledFrom Booking?  @relation("RescheduleChain", fields: [rescheduleFromId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    booking         Booking[] @relation("RescheduleChain")
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @updatedAt
    review          Review?

    @@map("bookings")
}

enum DayOfWeek {
    MONDAY // For weekly availability patterns
    TUESDAY
    WEDNESDAY
    THURSDAY
    FRIDAY
    SATURDAY
    SUNDAY
}

enum BookingStatus {
    PENDING // New booking by athlete, awaiting coach confirmation
    RESCHEDULE_REQUEST // Reschedule request from athlete (linked to old booking)
    CONFIRMED // Coach has confirmed the booking
    RESCHEDULED // Reschedule approved by coach
    CANCELLED // Booking cancelled by athlete or coach
    COMPLETED // Session completed (auto-update after date passes)
}
